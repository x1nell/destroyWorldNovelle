const storyParts = [
  {
    speaker: "Кацуми:",
    text: "Что вершит судьбу человечества?",
    imageUrl: "img/foni/1fon.png",
    nextPart: 1
  },
  {
    speaker: "Кацуми:",
    text: "Жизнь, или ожидание смерти - заставляет тебя двигаться дальше?",
    music: "msc/1track.mp3",
    imageUrl: "img/foni/1fon.png",
    nextPart: 2
  },
  {
    speaker: "Кацуми:",
    text: "Однажды и ты сможешь пройти свой путь до конца",
    imageUrl: "img/foni/1fon.png",
    nextPart: 3
  },
  {
    speaker: "Кацуми:",
    text: "Но сможешь ли ты вспомнить все моменты своей жизни после её окончания?",
    imageUrl: "img/foni/1fon.png",
    nextPart: 4
  },
  {
    speaker: "Кацуми:",
    text: "Существует ли в этом смысл? Почему у каждого живого существа есть свои рамки в мире?",
    imageUrl: "img/foni/1fon.png",
    nextPart: 5
  },
  {
    speaker: "Кацуми:",
    text: "Почему люди должны сидеть взаперти - как птицы в клетках, ведь пташки могут летать, но человек ограничил им доступ к свободе.",
    imageUrl: "img/foni/1fon.png",
    nextPart: 6
  },
  {
    speaker: "Кацуми:",
    text: "Так кто ограничил людям возможности?",
    imageUrl: "img/foni/1fon.png",
    nextPart: 7
  },
  {
    speaker: "Кацуми:",
    text: "Почему я должен сидеть в этой стереотипной для людей клетке, во избежание опасности, которой не было уже много лет?",
    imageUrl: "img/foni/1fon.png",
    nextPart: 8
  },
  {
    speaker: "Кацуми:",
    text: "быть может ничего и не существует на той стороне мира?",
    imageUrl: "img/foni/1fon.png",
    nextPart: 9
  },
  {
    speaker: "Кацуми:",
    text: "Эти мысли начали меня пробуждать к новому дню...",
    imageUrl: "img/foni/1fon.png",
    nextPart: 10
  },
  {
    speaker: "Кацуми:",
    text: "Что за странный сон мне приснился?",
    imageUrl: "img/foni/bedroomHome.png",
    music: "msc/2track.mp3",
    nextPart: 11
  },
  {
    speaker: "Кацуми:",
    text: "Снова начали всплывать слова матери:",
    imageUrl: "img/foni/bedroomHome.png",
    nextPart: 12
  },
  {
    speaker: "Мама:",
    text: "В далеком и загадочном мире, где судьбу решает человек, произошло неожиданное событие.",
    imageUrl: "img/foni/vospomHome.png",
    nextPart: 13
  },
  {
    speaker: "Мама:",
    text: "Величественные королевства Белое Инь...",
    imageUrl: "img/foni/korolevstvoWhite.png",
    nextPart: 14
  },
  {
    speaker: "Мама:",
    text: "и Черный Янь столкнулись,",
    imageUrl: "img/foni/korolevstvoBlack.png",
    nextPart: 15
  },
  {
    speaker: "Мама:",
    text: "Множество противоположностей и споров повлияло на острое лезвие судьбы.",
    imageUrl: "img/foni/vospomHome.png",
    nextPart: 16
  },
  {
    speaker: "Мама:",
    text: "Ведь теперь границы разделяли людей, отправившихся по полностью противоположным путям.",
    imageUrl: "img/foni/vospomHome.png",
    nextPart: 17
  },
  {
    speaker: "Мама:",
    text: "Со временем королевства укрепились, прошло много лет, но ни один человек из Инь так и не переступил порог Янь.",
    imageUrl: "img/foni/vospomHome.png",
    nextPart: 18
  },
  {
    speaker: "Кацуми:",
    text: "Чем могло быть вызвано такое решение?",
    imageUrl: "img/foni/vospomHome.png",
    nextPart: 19
  },
  {
    speaker: "Кацуми:",
    text: "Может быть, это было из-за страха или предубеждений, присущим обоим королевствам?",
    imageUrl: "img/foni/vospomHome.png",
    nextPart: 20
  },
  {
    speaker: "Кацуми:",
    text: "Или одержимость своими истинными ценностями, не позволяла проникнуть на территорию Янь? ",
    imageUrl: "img/foni/vospomHome.png",
    nextPart: 21
  },
  {
    speaker: "Кацуми:",
    text: "Интересно в чём же истина?",
    imageUrl: "img/foni/vospomHome.png",
    nextPart: 22
  },
  {
    speaker: "Мама:",
    text: "Для обычных людей Король нашего королевства не уточнил, но думаю тебе предстоит всё узнать мой дорогой,",
    imageUrl: "img/foni/vospomHome.png",
    nextPart: 23
  },
  {
    speaker: "Кацуми:",
    text: "И после этих слов и суждений, я на мгновение ощутил необычное чувство чего-то волшебного и необычного - исходящего от мамы,",
    imageUrl: "img/foni/vospomHome.png",
    nextPart: 24
  },
  {
    speaker: "Кацуми:",
    text: "не знаю на что это было похоже, но я не придал этому значения. ",
    imageUrl: "img/foni/vospomHome.png",
    nextPart: 25
  },
  {
    speaker: "Кацуми:",
    text: "Ладно, пора бы вставать - самый простой способ отойти от мыслей",
    imageUrl: "img/foni/bedroomHome.png",
    nextPart: 26
  },
  {
    speaker: "Кацуми:",
    text: "Мама оставила завтрак и ушла",
    imageUrl: "img/foni/kitchenHome.png",
    nextPart: 27
  },
  {
    speaker: "Кацуми:",
    text: "Хорошо покушал и отправился к выходу",
    imageUrl: "img/foni/kitchenHome.png",
    nextPart: 28
  },
  {
    speaker: "Кацуми:",
    text: "Мама снова закрыла меня - в целях безопасности",
    imageUrl: "img/foni/kitchenHome.png",
    nextPart: 29
  },
  {
    speaker: "Кацуми:",
    text: "И ключ забыла оставить - но я помню где лежит запасной - в моей комнате",
    imageUrl: "img/foni/kitchenHome.png",
    nextPart: 30
  },
  {
    speaker: "Кацуми:",
    text: "Должен быть где то здесь - мама специально оставляет тут запасной  ключ",
    imageUrl: "img/foni/bedroomHome.png",
    nextPart: 31
  },
  {
    speaker: "Кацуми:",
    text: "Надо найти тут ключ",
    imageUrl: "img/foni/bedroomHome.png",
    onItemAppear: function() {
      displayItemOnScreen("img/predmeti/keyHome.png", 1400, 450);
    },
    addItemToInventory: true,
    nextPart: 32
  },
  {
    speaker: "Кацуми:",
    text: "Отлично - ключ найден - отправляюсь к выходу",
    imageUrl: "img/foni/bedroomHome.png",
    nextPart: 33
  },
  {
    speaker: "Кацуми:",
    text: "Открыв дверь - я снова ощутил небольшую свободу...",
    imageUrl: "img/foni/kitchenHome.png",
    nextPart: 34
  },
  {
    speaker: "Кацуми:",
    text: "Красота в мелочах...",
    imageUrl: "img/foni/aroundHome.png",
    nextPart: 35
  },
];


let currentPart = parseInt(localStorage.getItem("currentPart")) || 0;
let isMusicPlaying = true;
const backgroundMusic = document.getElementById('backgroundMusic');
const storyTextElement = document.getElementById('storyText');
const storyImageElement = document.getElementById('storyImage');
const choicesContainer = document.getElementById('choices');
const characterImageElement = document.getElementById('characterImage');
const speakerElement = document.getElementById('speaker');
const storyContainer = document.getElementById('storyContainer');
const inventory = document.getElementById('inventory');
const menuContainer = document.getElementById('menuContainer');
const menuList = document.getElementById('menuList');
const musicControls = document.getElementById('musicControls');
const MAX_SAVED_SLOTS = 3;

let isItemVisible = false;
let isInventoryOpen = false;
let savedProgress = JSON.parse(localStorage.getItem("savedProgress")) || Array(MAX_SAVED_SLOTS).fill(null);

backgroundMusic.loop = true;
backgroundMusic.volume = 0.5;

function displayStoryPart(partIndex) {
  const part = storyParts[partIndex];

  speakerElement.textContent = part.speaker || "";
  if (part.music && isMusicPlaying) {
    backgroundMusic.src = part.music;
    backgroundMusic.play();
  }
  if (part.onItemAppear) part.onItemAppear();

  const canAddItem = part.itemImageUrl && part.addItemToInventory && canAddItemToScreen(partIndex);
  canAddItem ? displayItemOnScreen(part.itemImageUrl) : storyImageElement.src = part.imageUrl;

  storyTextElement.textContent = part.text;
  characterImageElement.innerHTML = part.characterImageUrl ? `<img src="${part.characterImageUrl}" alt="Персонаж">` : "";

  choicesContainer.innerHTML = "";
  part.choices?.forEach((choice, i) => {
    const choiceButton = document.createElement('button');
    choiceButton.textContent = choice.text;
    choiceButton.onclick = () => makeChoice(i);
    choicesContainer.appendChild(choiceButton);
  });
}

function startNewGame() {
    currentPart = 0;
    localStorage.setItem("currentPart", currentPart);
    displayStoryPart(currentPart);
    hideTitleScreen();
}

function continueGame() {
    currentPart = parseInt(localStorage.getItem("currentPart")) || 0;
    displayStoryPart(currentPart);
    hideTitleScreen();
}
function displayItemOnScreen(itemImageUrl, x = 0, y = 0) {
  const itemImage = document.createElement('img');
  itemImage.src = itemImageUrl;
  itemImage.classList.add('itemOnScreen');
  Object.assign(itemImage.style, { position: 'absolute', left: `${x}px`, top: `${y}px` });
  storyContainer.appendChild(itemImage);

  isItemVisible = true;
  itemImage.onclick = () => {
    addToInventory(itemImageUrl);
    itemImage.remove();
    isItemVisible = false;
  };
}

function makeChoice(choiceIndex) {
  const currentChoices = storyParts[currentPart]?.choices;
  if (!currentChoices || choiceIndex >= currentChoices.length) return alert("Неверный индекс выбора!");

  const nextPart = currentChoices[choiceIndex].nextPart;
  if (nextPart === undefined || nextPart === null) return alert("Этот выбор не имеет следующей части. Пожалуйста, проверьте конфигурацию истории.");

  currentPart = nextPart;
  currentPart === "end" || currentPart >= storyParts.length ? displayEnd() : displayStoryPart(currentPart);
  localStorage.setItem("currentPart", currentPart);
}

function displayEnd() {
  alert("Вы достигли конца истории!");
}

function nextPart(event) {
  const { clientX: clickX, clientY: clickY } = event;
  const imageRect = storyImageElement.getBoundingClientRect();
  const distance = Math.hypot(clickX - imageRect.left - imageRect.width / 2, clickY - imageRect.top - imageRect.height / 2);

  if (isItemVisible && distance <= imageRect.width / 2) {
    const nextPart = storyParts[currentPart]?.choices?.[0]?.nextPart;
    if (nextPart === undefined || nextPart === null) return alert("Этот выбор не имеет следующей части. Пожалуйста, проверьте конфигурацию истории.");

    currentPart = nextPart;
    currentPart === "end" ? displayEnd() : displayStoryPart(currentPart);
    localStorage.setItem("currentPart", currentPart);
  } else {
    const nextPart = storyParts[currentPart]?.nextPart;
    if (nextPart === undefined || nextPart === null) return alert("Этот выбор не имеет следующей части. Пожалуйста, проверьте конфигурацию истории.");

    currentPart = nextPart;
    currentPart === "end" ? displayEnd() : displayStoryPart(currentPart);
    localStorage.setItem("currentPart", currentPart);
  }
}

function toggleInventory() {
  isInventoryOpen = !isInventoryOpen;
  inventory.style.display = isInventoryOpen ? 'flex' : 'none';
}

function addToInventory(itemImageUrl) {
  const emptySlot = Array.from(document.querySelectorAll('.inventorySlot')).find(slot => !slot.hasItem);
  if (emptySlot) {
    emptySlot.style.backgroundImage = `url(${itemImageUrl})`;
    emptySlot.hasItem = true;
  }
}

function canAddItemToScreen(partIndex) {
  return storyParts[partIndex]?.addItemToInventory && !inventoryIsFull();
}

function inventoryIsFull() {
  return Array.from(document.querySelectorAll('.inventorySlot')).every(slot => slot.hasItem);
}

function toggleMenu() {
  menuContainer.style.display = menuContainer.style.display === 'none' || menuContainer.style.display === '' ? 'block' : 'none';
}

function goToPart(partIndex) {
  displayStoryPart(partIndex);
  localStorage.setItem("currentPart", partIndex);
  closeMenu();
}

function openMenu() {
  toggleMenu();
  updateMenuList();
}

function closeMenu() {
  menuContainer.style.display = 'none';
}

function saveProgress() {
  const slotIndex = parseInt(prompt(`Введите номер ячейки сохранения (1-${MAX_SAVED_SLOTS}):`)) - 1;
  if (isNaN(slotIndex) || slotIndex < 0 || slotIndex >= MAX_SAVED_SLOTS) return alert("Неправильный номер ячейки сохранения!");

  savedProgress[slotIndex] = currentPart;
  localStorage.setItem("savedProgress", JSON.stringify(savedProgress));
  updateMenuList();
  alert(`Прогресс сохранен в ячейке ${slotIndex + 1}!`);
}

function loadProgress() {
  const slotIndex = parseInt(prompt(`Введите номер ячейки сохранения (1-${MAX_SAVED_SLOTS}):`)) - 1;
  if (isNaN(slotIndex) || slotIndex < 0 || slotIndex >= MAX_SAVED_SLOTS || savedProgress[slotIndex] === null) return alert("Неправильный номер ячейки сохранения или в этой ячейке нет сохраненного прогресса!");

  currentPart = savedProgress[slotIndex];
  displayStoryPart(currentPart);
  localStorage.setItem("currentPart", currentPart);
  closeMenu();
  alert(`Прогресс загружен из ячейки ${slotIndex + 1}!`);
}

function updateMenuList() {
  menuList.innerHTML = savedProgress.map((progress, i) => {
    const text = `Ячейка ${i + 1}: ${progress !== null ? "Прогресс сохранен" : "Пусто"}`;
    return `<li data-slot-index="${i}" onclick="handleMenuClick(${i})">${text}</li>`;
  }).join('');
}

function handleMenuClick(slotIndex) {
  if (savedProgress[slotIndex] !== null) {
    currentPart = savedProgress[slotIndex];
    displayStoryPart(currentPart);
    closeMenu();
  } else {
    alert("В этой ячейке нет сохраненного прогресса!");
  }
}

function hideTitleScreen() {
  document.getElementById('titleScreen').style.display = 'none';
}

function showTitleScreen() {
  document.getElementById('titleScreen').style.display = 'flex';
}

document.addEventListener("DOMContentLoaded", () => {
  playMusic();
  showTitleScreen();
});

function toggleMusic() {
  musicControls.style.display = musicControls.style.display === 'none' ? 'block' : 'none';
}

function playMusic() {
  backgroundMusic.play();
  isMusicPlaying = true;
}

function pauseMusic() {
  backgroundMusic.pause();
  isMusicPlaying = false;
}

function setVolume(volume) {
  backgroundMusic.volume = parseFloat(volume);
}

document.addEventListener("DOMContentLoaded", playMusic);

localStorage.setItem('backgroundMusic', JSON.stringify({ isMusicPlaying, currentPart }));

displayStoryPart(currentPart);
document.body.style.cursor = "pointer";
